<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Arduino Piano üéπ</title>
</head>
<link rel="stylesheet" href="style.css">
<body>
    <header>
        <h1>Motion-based Synthesizer</h1>
    </header>
    <button id="connect">üîå Connect to Arduino</button><br><br>

    <section id ="piano-container">
        <div id="piano">
            <!-- White keys -->
            <div class="key white" data-note="C">C</div>
            <div class="key white" data-note="D">D</div>
            <div class="key white" data-note="E">E</div>
            <div class="key white" data-note="F">F</div>
            <div class="key white" data-note="G">G</div>
            <div class="key white" data-note="A">A</div>
            <div class="key white" data-note="B">B</div>

            <!-- Black keys -->
            <div class="key black" data-note="C#"></div>
            <div class="key black" data-note="D#"></div>
            <div class="key black" data-note="F#"></div>
            <div class="key black" data-note="G#"></div>
            <div class="key black" data-note="A#"></div>
        </div>
    </section>

    <section id="modes-container">
        <h2>Modes</h2>
        <p>Select different modes to change the sound and behavior of the synthesizer.</p>
        <button id="drum">Drum Mode</button>
    </section>

    <section id="score-container">
      <h2>Now Playing: <span id="current-note">‚Äî</span></h2>
      <div id="score">
        <img id="treble-clef" src="treble_clef.svg">

        <div class="staff-line"></div>
        <div class="staff-line"></div>
        <div class="staff-line"></div>
        <div class="staff-line"></div>
        <div class="staff-line"></div>

        <!-- <div id="note-head">‚óè</div> -->
        <div id="notes-layer"></div>

      </div>
    </section>


  <pre id="log"></pre>

  <script>
    let nextX = 0; //keep track of notes
    let port, writer;
    const log = document.getElementById("log");

    document.getElementById("connect").onclick = async () => {
        try {
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: 9600 });
            writer = port.writable.getWriter();
            log.textContent += "Connected to Arduino!\n";

            readFromArduino();
        } catch (error) {
            console.error("Connection failed:", error);
            log.textContent += `Error: ${error.message}\n`;
    }
    };

    document.getElementById("drum").onclick = async () => {
      if (!writer) {
        log.textContent += "Please connect first.\n";
        return;
      }
      await writer.write(new TextEncoder().encode("d"));
      log.textContent += "Switched to drum mode\n";
    };

    const notePositions = {
      "C": 7,
      "C#": 7,
      "D": 1,
      "D#": 1,
      "E": -5,
      "F": 31,
      "F#": 31,
      "G": 25,
      "G#": 25,
      "A": 19,
      "A#": 19,
      "B": 13
    };




    async function sendNote(note) {
      if (!writer) {
        log.textContent += "Please connect first.\n";
        return;
      }
      await writer.write(new TextEncoder().encode(note));
      log.textContent += `Played note: ${note}\n`;

       updateScore(note);
    }


    document.querySelectorAll(".key").forEach(key => {
      key.onclick = () => sendNote(key.dataset.note);
    });
    
    let reader;

    async function readFromArduino() {
      while (port.readable) {
        reader = port.readable.getReader();
        try {
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            if (value) {
              const text = new TextDecoder().decode(value);
              handleArduinoMessage(text);
            }
          }
        } catch (error) {
          console.error(error);
        } finally {
          reader.releaseLock();
        }
      }
    }

    function handleArduinoMessage(msg) {
  msg.split("\n").forEach(line => {
    line = line.trim();
    if (line.startsWith("NOTE:")) {
      const note = line.slice(5); // remove NOTE:
      if (note === "0") {
        document.getElementById("current-note").textContent = "-";
        return;
      } else {
        updateScore(note); // now only this
      }
    }
  });
}
  

    function updateScore(note) {
      const notesLayer = document.getElementById("notes-layer");

      const y = notePositions[note];  // your vertical mapping
      const x = nextX;

      // Create the note head
      const div = document.createElement("div");
      div.className = "note-head";
      div.textContent = "‚óè";
      div.style.top = y + "px";
      div.style.left = x + "px";

      // Add to staff
      notesLayer.appendChild(div);

      // Move the cursor right for the next note
      nextX += 40;  // spacing between notes

      // (Optional) auto-scroll if full
      if (nextX > 700) {  // near right edge of your 800px score
        notesLayer.style.transform = `translateX(${700 - nextX}px)`;
      }

      // Update "Now Playing"
      document.getElementById("current-note").textContent = note;
    }

  </script>
</body>
</html>